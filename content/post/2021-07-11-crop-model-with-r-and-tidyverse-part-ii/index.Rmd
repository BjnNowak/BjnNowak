---
title: "[R] Crop model with tidyverse (Part II)"
author: Benjamin Nowak
date: '2021-07-11'
slug: crop-model-with-r-and-tidyverse-part-ii
categories: ["R"]
tags:
  - modelisation
  - R
  - tidyverse
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Set Working directory for Notebook
knitr::opts_knit$set(root.dir='/Users/bnowak/Documents/231220/WD/AnalyseSyst/')
```


```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Load data 
input <- read.table(file="Weather_DesMoines.csv", header=TRUE, sep=";",dec=".")
# Clean data
data<-input%>%
  dplyr::select(
    tas = T_DAILY_MEAN,
    rsds = SOLARAD_DAILY  
  )%>% 
  dplyr::mutate(                
    day_number = row_number()     
  )%>%
  dplyr::filter(
    day_number>=92                # Keep only data after April 1st (included)
  )

# Outside the function:
# Rquired parameters to compute C
# Light extinction coefficient
K <- 0.56
# Individual leaf area (m-2)
S <- 0.05
# Plant density (m-2)
d <- 90000/10000

# Model function
model_fun <- function(
  name,           # Scenario name 
  data,           # Climatic variables to be used as inputs
  GDD_1leaf,      # Thermal requirement for the emergence of one leaf
  C,              # C=f(K,S,d)
  RUE,            # Radiation use efficiency (gDM.MJ-1)
  nthresh         # Number of leaves before grain filling
  ){      
  # Set parameters (without GDD_1leaf)
  max_nleaf<-20
  T0<-6 
  f<-0.5      # Active fraction of incoming radiation
  frac<-0.7   # Fraction of Net Primary Productivity dedicated to grain
  
  # Estimate yield
  model<-data%>%
    dplyr::mutate(
      TT=dplyr::case_when(
        tas<T0~0,
        tas>=T0~tas-T0
    ))%>%  
    mutate(
      GDD = cumsum(TT)
    )%>%
    mutate(
      pot_nleaf = GDD/GDD_1leaf
    )%>%
    mutate(
      nleaf = case_when(
        pot_nleaf<=max_nleaf~round(pot_nleaf),
        pot_nleaf>max_nleaf~max_nleaf
      )
    )%>%
     # Incoming photosynthetic active radiation (MJ.m-2.day-1)
    mutate(
      PAR_inc = f*rsds
    )%>%
    # Absorbed PAR by the canopy (MJ.m-2.day-1)
    mutate(
      APAR = PAR_inc*(1-exp(-C*nleaf))
    )%>%
    # Net primary productivity dedicated to the aboveground biomass 
    mutate(
      NPP = RUE*APAR
    )%>%
    # Sum of aboveground biomass
    mutate(
      biom = cumsum(NPP)
    )%>%
    # Net primary productivity dedicated to the variable grain
    mutate(
      NPPgrain = case_when(
        nleaf<nthresh ~ 0,
        nleaf>=nthresh ~ frac*NPP
      )
    )%>%
    # Total grain production (g.m-2)
    mutate(
      grain = cumsum(NPPgrain)
    )%>%
    # Total grain production (t.ha-1)
    mutate(
      grain_t = grain/100
    )%>%
    add_column(                                # To add scenario name to data
      Scenario = name                          # (set 'name' in argument)
    )
  return(model)
}

```

**Goals:**   

  * Perform sensitivity/uncertainty analysis 
  * Calculate Root Mean Square Error 
  * Optimize the model

In the first part, we created a model that estimates the maximum potential yield of corn based on weather data (temperature and solar radiation). Briefly, this estimation is done in three steps:     
  **1.** Estimation of number of leaves (based on daily temperature)    
  **2.** Estimation of the amount of photosynthetically active radiation intercepted by the plants   
  **3.** Conversion of this amount of radiation into biomass (first plant then grain)    

We will now investigate the influence of the different parameters on the model's results. 

we will use the same data as for the first part, as well as the function created to run the model. We won't go into detail about the data or the creation of this function here, but you must have it loaded in your script to use it (if necessary, you may find the code of this function in the Appendix of [the first part](https://bjnnowak.netlify.app/2021/07/01/r-crop-model-with-tidyverse-part-i/)).

```{r, message=FALSE, warning=FALSE}
# Load tidyverse 
library(tidyverse)

# Apply function (need to be loaded first)
baseline <- model_fun(
  name="DesMoines", 
  data=data, 
  GDD_1leaf = 50,
  C=K*S*d,
  RUE=2.5,
  nthresh = 16
)
# Plotting results
ggplot(data=baseline,aes(x=day_number,y=grain_t))+
  geom_point()+
  labs(  
    title = "Comparison between two cities",
    x = "Day number",
    y = "Potential max yield (t.ha-1)"
  )

```
