---
title: "[R] Crop model with tidyverse (Part II)"
author: Benjamin Nowak
date: '2021-07-11'
slug: crop-model-with-r-and-tidyverse-part-ii
categories: ["R"]
tags:
  - modelisation
  - R
  - tidyverse
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Set Working directory for Notebook
knitr::opts_knit$set(root.dir='/Users/bnowak/Documents/231220/WD/AnalyseSyst/')
```


```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
# Load data 
input <- read.table(file="Weather_DesMoines.csv", header=TRUE, sep=";",dec=".")
# Clean data
data<-input%>%
  dplyr::select(
    tas = T_DAILY_MEAN,
    rsds = SOLARAD_DAILY  
  )%>% 
  dplyr::mutate(                
    day_number = row_number()     
  )%>%
  dplyr::filter(
    day_number>=92                # Keep only data after April 1st (included)
  )

# Outside the function:
# Rquired parameters to compute C
# Light extinction coefficient
K <- 0.56
# Individual leaf area (m-2)
S <- 0.05
# Plant density (m-2)
d <- 90000/10000

# Model function
model_fun <- function(
  name,           # Scenario name 
  data,           # Climatic variables to be used as inputs
  GDD_1leaf,      # Thermal requirement for the emergence of one leaf
  C,              # C=f(K,S,d)
  RUE,            # Radiation use efficiency (gDM.MJ-1)
  nthresh         # Number of leaves before grain filling
  ){      
  # Set parameters (without GDD_1leaf)
  max_nleaf<-20
  T0<-6 
  f<-0.5      # Active fraction of incoming radiation
  frac<-0.7   # Fraction of Net Primary Productivity dedicated to grain
  
  # Estimate yield
  model<-data%>%
    dplyr::mutate(
      TT=dplyr::case_when(
        tas<T0~0,
        tas>=T0~tas-T0
    ))%>%  
    mutate(
      GDD = cumsum(TT)
    )%>%
    mutate(
      pot_nleaf = GDD/GDD_1leaf
    )%>%
    mutate(
      nleaf = case_when(
        pot_nleaf<=max_nleaf~round(pot_nleaf),
        pot_nleaf>max_nleaf~max_nleaf
      )
    )%>%
     # Incoming photosynthetic active radiation (MJ.m-2.day-1)
    mutate(
      PAR_inc = f*rsds
    )%>%
    # Absorbed PAR by the canopy (MJ.m-2.day-1)
    mutate(
      APAR = PAR_inc*(1-exp(-C*nleaf))
    )%>%
    # Net primary productivity dedicated to the aboveground biomass 
    mutate(
      NPP = RUE*APAR
    )%>%
    # Sum of aboveground biomass
    mutate(
      biom = cumsum(NPP)
    )%>%
    # Net primary productivity dedicated to the variable grain
    mutate(
      NPPgrain = case_when(
        nleaf<nthresh ~ 0,
        nleaf>=nthresh ~ frac*NPP
      )
    )%>%
    # Total grain production (g.m-2)
    mutate(
      grain = cumsum(NPPgrain)
    )%>%
    # Total grain production (t.ha-1)
    mutate(
      grain_t = grain/100
    )%>%
    add_column(                                # To add scenario name to data
      Scenario = name                          # (set 'name' in argument)
    )
  return(model)
}

```

**Goals:**   

  * Perform sensitivity analysis
  * Perform uncertainty analysis 
  * Plot results

In the first part, we created a model that estimates the maximum potential yield of corn based on weather data (temperature and solar radiation). Briefly, this estimation is done in three steps:     
  **1.** Estimation of number of leaves (based on daily temperature)    
  **2.** Estimation of the amount of photosynthetically active radiation intercepted by the plants   
  **3.** Conversion of this amount of radiation into biomass (first plant then grain)    

We will now investigate the influence of the different parameters on the model's results. 

we will use the same data as for the first part, as well as the function created to run the model. We won't go into detail about the data or the creation of this function here, but you must have it loaded in your script to use it (if necessary, you may find the code of this function in the Appendix of [the first part](https://bjnnowak.netlify.app/2021/07/01/r-crop-model-with-tidyverse-part-i/)).

```{r, message=FALSE, warning=FALSE}
# Load tidyverse 
library(tidyverse)
# Load previous data and function (not shown here)
# Apply function once loaded
baseline <- model_fun(
  name="DesMoines", 
  data=data, 
  GDD_1leaf = 50,
  C=0.12,
  RUE=2,
  nthresh = 16
)
# Plotting results
ggplot(data=baseline,aes(x=day_number,y=grain_t))+
  geom_point()+
  labs(  
    title = "Comparison between two cities",
    x = "Day number",
    y = "Potential max yield (t.ha-1)"
  )

```

# 1. Sensitivity analysis

A sensitivity analysis is used to determine the effect of uncertainty about the variables or parameters of a model on the final result. Here, we will evaluate the effect of two parameters: $C$, which reflects the crops's capacity to intercept light and the Radiation Use Efficieny ($RUE$, in gDM.MJ-1), which estimates the conversion of the intercepted radiation into biomass.

The parameter C can be decomposed in different parameters according to the following equation:
  
$$
\quad\text{(Eq. 1)}\quad C = k*S_{leaf}*d_{plant}
$$
where $k$ is the light extinction coefficient (reflecting light penetration in crop's foliage), $S_{leaf}$ is the individual leaf area, and $d_{plant}$ is the plant density. These three parameters will be evaluated simultaneously by the sensitivity analysis perfomed on $C$.

An important part of sensitivity analysis is to determine the boundaries of each parameter, which can be done through a literature review. For this tutorial, we will take the same boundaries as Ringeval *et al.* (2021): [0.06; 0.18] for $C$ and [1; 3] for $RUE$.

We will now create a data frame that will store the different values that these coefficients can take:


```{r, message=FALSE, warning=FALSE}

input<-data.frame(
    C_draw=seq(0.06,0.18,0.03),  # C varies from 0.06 to 0.18 with a step of 0.03
    RUE_draw=seq(1,3,0.5),       # RUE varies from 1 to 3 with a step of 0.5
    relative_draw=seq(0,1,0.25)  # To compare both variables on the same scale
  )

input

```
Before applying our model to each of these cases, we need to prepare the data. 
To simplify the sensitivity analysis we will limit ourselves to the comparison of the final yield. To do this, we will use the tail() function to extract only the last value.

```{r, message=FALSE, warning=FALSE}

output<-model_fun(
  name="DesMoines", 
  data=data, 
  GDD_1leaf = 50,
  C=0.12,
  RUE=2,
  nthresh = 16
  )%>%
  select(grain_t)%>%        # Select only yield values
  tail(1)                   # Select only the last row 
output

```

We will now create a new function that performs this extraction by taking as arguments our two variables of interest $C$ and $RUE$:

```{r, message=FALSE, warning=FALSE}
# Function creation
sensitivity_fun<-function(C_vec,RUE_vec){
  output<-model_fun(
    name="DesMoines", 
    data=data, 
    GDD_1leaf = 50,
    C=C_vec,
    RUE=RUE_vec,
    nthresh = 16
    )%>%
    select(grain_t)%>%        # Select only yield values
    tail(1)
  return(as.numeric(output))
}
# "Manual" analysis with different values:
sensitivity_fun(C_vec=0.12,RUE_vec=3)

```
We are now going to apply this function to the input data frame that we have prepared before. To do so, we will use the mapply() function, that allows to iterate the same function over a vector without the need of using the for loop, that is known to be slow in R. Compared to sapply(), which can perform the same task, mapply can take several arguments. The structure of the function is: mapply(FunctionName, Argument1, Argument2...).

A sensitivity analysis is conducted by varying each parameter independently. We will start with C:
```{r, message=FALSE, warning=FALSE}

sensitivity<-input%>%
  # "Pipe" our function to the input data frame:
  mutate(
    C_analysis=mapply(
      sensitivity_fun,     # Name of the function
      C_vec=C_draw,        # Argument 1: C (varies)
      RUE_vec=2            # Argument 2: RUE (does not vary yet)
    )
  )

# Plot results
ggplot(sensitivity,aes(x=C_draw,y=C_analysis))+
  geom_line()+
    labs(                                  # Customize labels
    title = "Sensitivity analysis: C",
    x = "C",
    y = "Potential max yield (t.ha-1)"
  )


```
```{r, message=FALSE, warning=FALSE}

sensitivity<-input%>%
  mutate(
    C_analysis=mapply(sensitivity_fun,RUE_vec=2,C_vec=C_draw)
  )%>%
  mutate(
    RUE_analysis=mapply(sensitivity_fun,RUE_vec=RUE_draw,C_vec=0.12)
  )

ggplot(sensitivity)+
  geom_line(aes(x=relative_draw,y=C_analysis),col="blue")+
  geom_line(aes(x=relative_draw,y=RUE_analysis),col="red")+
    labs(                                  # Customize labels
    title = "Sensitivity analysis: C (blue) and RUE (red)",
    x = "Parameters variation (relative scale)",
    y = "Potential max yield (t.ha-1)"
  )


```

According to the first results of this sensitivity analysis, it seems that the conversion of solar radiation to biomass influences the results more than the interception stage.


# 2. Uncertainty analysis

```{r, message=FALSE, warning=FALSE}
# Number of draws
N=100

uncertainty<-data.frame(
    RUE_draw=runif(100,1,3),
    C_draw=runif(100,0.06,0.18)
  )%>%
  mutate(
    uncertainty=mapply(sensitivity_fun,RUE_vec=RUE_draw,C_draw)
  )

ggplot(uncertainty,aes(y=uncertainty))+
  geom_boxplot()

```




